name: AI Agent (Inline JS + Multi-turn + PR)

on:
  issue_comment:
    types: [created]

jobs:
  agent:
    if: contains(github.event.comment.body, '@agent')
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Prepare branch
        run: |
          BRANCH=agent/issue-${{ github.event.issue.number }}
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV
          git checkout -B "$BRANCH"

      # ğŸ§  æ„å»ºå¤šè½® Promptï¼ˆâš ï¸ æ— æ¨¡æ¿å­—ç¬¦ä¸²ï¼‰
      - name: Build conversation prompt
        id: prompt
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            let prompt = "ã€Issue æè¿°ã€‘\n";
            prompt += issue.data.title + "\n\n";
            prompt += (issue.data.body || "") + "\n\n";
            prompt += "ã€å†å²å¯¹è¯ã€‘\n";

            comments.data.slice(-10).forEach(c => {
              if (c.body.includes("@agent")) {
                prompt += "User: " + c.body + "\n";
              }
              if (c.user.type === "Bot" && c.body.includes("AI Agent")) {
                prompt += "Agent: " + c.body + "\n";
              }
            });

            prompt += "\nã€å½“å‰æŒ‡ä»¤ã€‘\n";
            prompt += context.payload.comment.body;

            core.setOutput("prompt", prompt);

      # ğŸ¤– Inline Agentï¼ˆå®Œå…¨ YAML-safeï¼‰
      - name: Run Inline Agent
        env:
          AGENT_PROMPT: ${{ steps.prompt.outputs.prompt }}
        run: |
          node <<'EOF'
          const fs = require("fs");
          const path = "docs/index.html";
          fs.mkdirSync("docs", { recursive: true });
          
          fs.writeFileSync(
            path,
            "<!doctype html>\n" +
            "<html lang=\"en\">\n" +
            "<head>\n" +
            "  <meta charset=\"utf-8\" />\n" +
            "  <title>SecureX</title>\n" +
            "  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n" +
            "  <style>\n" +
            "    body { margin:0; font-family:system-ui; background:#0b0f19; color:#e5e7eb; }\n" +
            "    header { padding:64px; text-align:center; }\n" +
            "    .card { background:#111827; border-radius:16px; padding:40px; max-width:900px; margin:32px auto; }\n" +
            "    .accent { color:#38bdf8; }\n" +
            "  </style>\n" +
            "</head>\n" +
            "<body>\n" +
            "  <header>\n" +
            "    <h1>Hello <span class=\"accent\">Agent</span></h1>\n" +
            "    <p>Enterprise-grade encrypted infrastructure</p>\n" +
            "  </header>\n" +
            "  <div class=\"card\">Security-first platform</div>\n" +
            "</body>\n" +
            "</html>\n"
          );
          EOF
          
      # ğŸ” è°ƒè¯•ï¼ˆéå¸¸é‡è¦ï¼‰
      - name: Debug docs
        run: |
          echo "PWD: $(pwd)"
          ls -l docs
          cat docs/index.html
          
      - name: Commit changes
        run: |
          git config user.name "AI Agent"
          git config user.email "agent@github.com"
          git add docs/index.html
          git commit -m "AI Agent: create/update docs/index.html"

      - name: Push branch
        run: |
          git push origin "$BRANCH" --force

      - name: List remote branches
        run: git ls-remote


      - name: Create or Update Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: main
          branch: ${{ env.BRANCH }}
          title: "ğŸ¤– AI Agent PR"
          body: |
            Agent completed one iteration.
            Review and reply `@agent merge`.


      - name: Auto merge
        if: contains(github.event.comment.body, '@agent merge')
        uses: actions/github-script@v7
        with:
          script: |
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: context.repo.owner + ":" + process.env.BRANCH,
              state: "open"
            });

            if (prs.data.length) {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prs.data[0].number,
                merge_method: "squash"
              });
            }
