name: AI Agent (Cline PR Mode + Multi-turn)

on:
  issue_comment:
    types: [created]

jobs:
  agent:
    # åªå“åº” @agent
    if: contains(github.event.comment.body, '@agent')
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Cline
        run: npm install -g @cline/cli

      # ğŸŒ¿ å›ºå®š Agent å·¥ä½œåˆ†æ”¯ï¼ˆå¤šè½®å¯¹è¯å…³é”®ï¼‰
      - name: Prepare branch
        run: |
          echo "BRANCH=agent/issue-${{ github.event.issue.number }}" >> $GITHUB_ENV
          git checkout -B agent/issue-${{ github.event.issue.number }}

      # ğŸ§  æ„å»ºå¤šè½®å¯¹è¯ Promptï¼ˆIssue + Comment å†å²ï¼‰
      - name: Build conversation prompt
        id: prompt
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            let prompt = `ã€Issue æè¿°ã€‘\n${issue.data.title}\n\n${issue.data.body || ''}\n\n`;
            prompt += `ã€å†å²å¯¹è¯ã€‘\n`;

            // åªå–æœ€è¿‘ 10 æ¡ï¼Œé˜²æ­¢ prompt è¿‡é•¿
            const recentComments = comments.data.slice(-10);

            for (const c of recentComments) {
              if (c.body.includes('@agent')) {
                prompt += `User: ${c.body}\n`;
              }
              if (c.user.type === 'Bot' && c.body.includes('AI Agent')) {
                prompt += `Agent: ${c.body}\n`;
              }
            }

            prompt += `\nã€å½“å‰æŒ‡ä»¤ã€‘\n${context.payload.comment.body}`;

            core.setOutput('prompt', prompt);

      # ğŸ¤– è¿è¡Œ Cline Agentï¼ˆå—é™ç›®å½• + å¤šè½®ä¸Šä¸‹æ–‡ï¼‰
      - name: Run Cline Agent
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          cline run \
            --prompt "${{ steps.prompt.outputs.prompt }}" \
            --auto-approve \
            --commit \
            --model claude-3.5-sonnet \
            --allowed-paths src/,tests/,docs/ \
            --deny-paths .github/,infra/,scripts/

      - name: Push branch
        run: git push origin $BRANCH

      # ğŸ”€ åˆ›å»º / æ›´æ–° PRï¼ˆåŒä¸€ä¸ª PR å¤šè½®æ›´æ–°ï¼‰
      - name: Create or Update Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ env.BRANCH }}
          title: "ğŸ¤– AI Agent: Issue #${{ github.event.issue.number }}"
          body: |
            ## ğŸ¤– AI Agent è‡ªåŠ¨ä¿®æ”¹å®Œæˆï¼ˆæ”¯æŒå¤šè½®å¯¹è¯ï¼‰

            **å½“å‰æŒ‡ä»¤**
            ```
            ${{ github.event.comment.body }}
            ```

            **æ”¹åŠ¨èŒƒå›´é™åˆ¶**
            - âœ… src/
            - âœ… tests/
            - âœ… docs/
            - âŒ .github/
            - âŒ infra/
            - âŒ scripts/

            è¯· Review ğŸ‘‡

      # ğŸ’¬ Agent ä¸»åŠ¨å› Issueï¼ˆåƒçœŸäººä¸€æ ·æ±‡æŠ¥ï¼‰
      - name: Comment back to Issue
        uses: actions/github-script@v7
        with:
          script: |
            const body =
              "ğŸ¤– **AI Agent å·²å®Œæˆä¸€è½®ä»»åŠ¡**\n\n" +
              "- ğŸ”€ PR å·²åˆ›å»º / æ›´æ–°\n" +
              `- ğŸŒ¿ åˆ†æ”¯ï¼š${process.env.BRANCH}\n` +
              "- ğŸ§  å·²è¯»å–å†å²å¯¹è¯ä¸Šä¸‹æ–‡\n" +
              "- ğŸ“¦ æ”¹åŠ¨å·²é™åˆ¶åœ¨æŒ‡å®šç›®å½•\n\n" +
              "ğŸ‘‰ å¦‚éœ€ç»§ç»­ï¼Œè¯·åœ¨æœ¬ Issue ä¸­å†æ¬¡ @agent ä¸‹è¾¾æŒ‡ä»¤";

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });
