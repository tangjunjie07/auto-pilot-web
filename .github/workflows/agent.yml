name: AI Agent (OpenAI + HTML + PR)

on:
  issue_comment:
    types: [created]

jobs:
  agent:
    if: contains(github.event.comment.body, '@agent')
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Prepare branch
        run: |
          BRANCH=agent/issue-${{ github.event.issue.number }}
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV
          git checkout -B "$BRANCH"

      - name: Install dependencies
        run: npm install openai

      # ğŸ§  æ„å»ºå¤šè½® Prompt
      - name: Build conversation prompt
        id: prompt
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            let prompt = "ã€Issue æè¿°ã€‘\n";
            prompt += issue.data.title + "\n\n";
            prompt += (issue.data.body || "") + "\n\n";
            prompt += "ã€å†å²å¯¹è¯ã€‘\n";

            comments.data.slice(-10).forEach(c => {
              if (c.body.includes("@agent")) {
                prompt += "User: " + c.body + "\n";
              }
              if (c.user.type === "Bot" && c.body.includes("AI Agent")) {
                prompt += "Agent: " + c.body + "\n";
              }
            });

            prompt += "\nã€å½“å‰æŒ‡ä»¤ã€‘\n";
            prompt += context.payload.comment.body;

            core.setOutput("prompt", prompt);

      # ğŸ¤– AI Agent (OpenAI)
      - name: Run Inline Agent (OpenAI)
        env:
          AGENT_PROMPT: ${{ steps.prompt.outputs.prompt }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          node <<'EOF'
          const fs = require("fs");
          const path = require("path");
          const OpenAI = require("openai").default;
          const { execSync } = require("child_process");

          const prompt = process.env.AGENT_PROMPT || "ç”Ÿæˆ HTML é¡µé¢";
          const filePath = path.join(process.cwd(), "docs", "main.html");
          const branch = process.env.BRANCH;

          (async () => {
            try {
              const client = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

              const res = await client.chat.completions.create({
                model: "gpt-4o-mini",
                messages: [
                  { role: "system", content: "ä½ æ˜¯ç½‘é¡µç”Ÿæˆ AIï¼Œæ ¹æ®ç”¨æˆ·æŒ‡ä»¤ç”Ÿæˆå®Œæ•´ HTML é¡µé¢ã€‚" },
                  { role: "user", content: prompt }
                ],
                temperature: 0.7,
                max_tokens: 3000
              });

              let html = res.choices[0].message.content || "<h1>ç”Ÿæˆå¤±è´¥</h1>";
              // ğŸŸ¢ åªæå– ```html ... ``` ä¸­çš„å†…å®¹
              const match = html.match(/```html\s*([\s\S]*?)```/i);
              if (match) {
                html = match[1].trim();
              }
              console.log("OpenAI generated HTML:", html);

              fs.mkdirSync(path.dirname(filePath), { recursive: true });
              fs.writeFileSync(filePath, html, "utf-8");
              console.log("docs/main.html generated at", filePath);

              // Git æäº¤ HTML æ–‡ä»¶
              execSync('git config user.name "AI Agent"');
              execSync('git config user.email "agent@github.com"');
              execSync(`git add ${filePath}`);
              const status = execSync('git status --short').toString().trim();
              console.log("Git status after add:\n", status);
              execSync(`git commit -m "AI Agent: create/update docs/main.html" --allow-empty`);
              execSync(`git push origin ${branch} --force`);
              console.log("âœ… HTML æ–‡ä»¶å·²æäº¤åˆ°åˆ†æ”¯:", branch);
            } catch (err) {
              console.error("ç”Ÿæˆ HTML å¤±è´¥:", err);
              process.exit(1);
            }
          })();
          EOF

      - name: Create or Update Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: main
          branch: ${{ env.BRANCH }}
          title: "ğŸ¤– AI Agent PR"
          body: |
            Agent completed one iteration.
            Review and reply `@agent merge`.
          commit-message: "[create-pull-request] automated change"

      - name: Reply to issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: "âœ… HTML é¡µé¢å·²ç”Ÿæˆå¹¶æäº¤ PR: #${{ github.event.issue.number }}"
            });

      - name: Auto merge
        if: contains(github.event.comment.body, '@agent merge')
        uses: actions/github-script@v7
        with:
          script: |
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: context.repo.owner + ":" + process.env.BRANCH,
              state: "open"
            });
            if (prs.data.length) {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prs.data[0].number,
                merge_method: "squash"
              });
            }
